name: CD - Deploy API + UI to Dev

on:
  push:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  API_IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/cs598-api
  UI_IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/cs598-ui

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    outputs:
      api_image: ${{ steps.set-image-output.outputs.api_image }}
      ui_image: ${{ steps.set-image-output.outputs.ui_image }}
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set image tag
        id: meta
        run: |
          echo "TAG=${GITHUB_SHA}" >> $GITHUB_ENV

      - name: Build and push API image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ${{ env.API_IMAGE_REPO }}:${{ env.TAG }}
            ${{ env.API_IMAGE_REPO }}:latest

      - name: Build and push UI image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.ui
          push: true
          tags: |
            ${{ env.UI_IMAGE_REPO }}:${{ env.TAG }}
            ${{ env.UI_IMAGE_REPO }}:latest

      - name: Set image outputs
        id: set-image-output
        run: |
          echo "api_image=${{ env.API_IMAGE_REPO }}:${{ env.TAG }}" >> $GITHUB_OUTPUT
          echo "ui_image=${{ env.UI_IMAGE_REPO }}:${{ env.TAG }}" >> $GITHUB_OUTPUT

  deploy-dev:
    name: Deploy to Dev Cluster
    needs: build-and-push
    runs-on: ubuntu-latest
    environment:
      name: dev
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "latest"

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${KUBE_CONFIG_DEV}" | base64 -d > ~/.kube/config
        env:
          KUBE_CONFIG_DEV: ${{ secrets.KUBE_CONFIG_DEV }}

      - name: Ensure namespace
        run: kubectl apply -f k8s/dev/namespace.yaml

      - name: Apply API Service
        run: kubectl apply -f k8s/dev/service-api.yaml

      - name: Apply UI Service
        run: kubectl apply -f k8s/dev/service-ui.yaml

      - name: Apply base API Deployment
        run: kubectl apply -f k8s/dev/deployment-api.yaml

      - name: Apply base UI Deployment
        run: kubectl apply -f k8s/dev/deployment-ui.yaml

      - name: Update API image
        run: |
          API_IMAGE="${{ needs.build-and-push.outputs.api_image }}"
          echo "Rolling out API image: ${API_IMAGE}"
          kubectl set image deployment/deepfake-api \
            deepfake-api="${API_IMAGE}" \
            -n deepfake-dev

      - name: Update UI image
        run: |
          UI_IMAGE="${{ needs.build-and-push.outputs.ui_image }}"
          echo "Rolling out UI image: ${UI_IMAGE}"
          kubectl set image deployment/deepfake-ui \
            deepfake-ui="${UI_IMAGE}" \
            -n deepfake-dev

      - name: Wait for API rollout
        run: |
          kubectl rollout status deployment/deepfake-api \
            -n deepfake-dev \
            --timeout=180s

      - name: Wait for UI rollout
        run: |
          kubectl rollout status deployment/deepfake-ui \
            -n deepfake-dev \
            --timeout=180s

      - name: Run smoke test job
        run: |
          kubectl delete job deepfake-api-smoke-test -n deepfake-dev --ignore-not-found=true
          kubectl apply -f k8s/dev/smoke-test-job.yaml
          kubectl wait --for=condition=complete job/deepfake-api-smoke-test \
            -n deepfake-dev --timeout=60s

      - name: Show pods
        if: always()
        run: kubectl get pods -n deepfake-dev -o wide